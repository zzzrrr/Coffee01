<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>IoT 行動儀表板</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg: #0b0f14; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22d3ee; --ok:#22c55e; --warn:#f59e0b;
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f6f7fb; --card:#ffffff; --muted:#475569; --text:#0f172a; --accent:#0891b2; }
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC",sans-serif}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(0,0,0,.55),rgba(0,0,0,0));backdrop-filter: blur(8px); padding:12px 16px}
    .bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    h1{font-size:20px;margin:0;font-weight:700;letter-spacing:.2px}
    .pill{display:flex;align-items:center;gap:8px;border:1px solid rgba(148,163,184,.25);border-radius:999px;padding:6px 10px;background:var(--card)}
    .pill small{color:var(--muted)}
    .btn{border:0;border-radius:12px;padding:10px 14px;background:var(--accent);color:white;font-weight:700;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .grid{display:grid;grid-template-columns:1fr;gap:12px;padding:12px 12px 24px}
    @media(min-width:640px){.grid{grid-template-columns:1fr 1fr}}
    @media(min-width:1024px){.grid{grid-template-columns:1fr 1fr 1fr}}
    .card{background:var(--card);border:1px solid rgba(148,163,184,.2);border-radius:16px;overflow:hidden}
    .card h3{font-size:14px;margin:0;padding:10px 12px;border-bottom:1px solid rgba(148,163,184,.15);display:flex;justify-content:space-between;align-items:center;color:var(--muted)}
    .card .body{padding:8px 8px 12px}
    canvas{width:100%;height:220px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .tag{font-size:12px;color:var(--muted)}
    footer{padding:16px 14px;color:var(--muted);font-size:12px}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#111827;color:#fff;padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,.1);opacity:0;transition:all .3s}
    .toast.show{opacity:1;bottom:28px}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <h1>IoT 行動儀表板</h1>
      <div class="pill"><small>Channel</small> <span id="channelName">—</span></div>
      <div class="pill"><small>更新</small> <span id="lastUpdated">—</span></div>
      <button id="zeroBtn" class="btn" title="透過 TalkBack 傳送 ZERO 讓 GY521 俯仰角歸零">俯仰角歸零</button>
    </div>
  </header>

  <main class="grid" id="grid"></main>

  <footer>
    READ API Key 僅用於讀取資料；TalkBack 僅送出 <code>ZERO</code> 指令。若此頁需公開，請在伺服器側封裝敏感金鑰。
  </footer>

  <div class="toast" id="toast">訊息</div>

  <script>
    // ====== 設定區 ======
    const READ_API_KEY = "2PT0U0D31H9Q312Q";         // 提供的 Read API Key
    const CHANNEL_ID = 1351240;                       // 你的 ThingSpeak Channel ID
    const TALKBACK_ID = "55279";                      // 提供的 TalkBack ID
    const TALKBACK_API_KEY = "ENW5KUIMAN9WSYE4";      // 提供的 TalkBack API Key
    const RESULTS = 100;                               // 過去 100 筆

    const desiredLabels = [
      "溫度 (°C)",
      "濕度 (%RH)",
      "大氣壓力 (hPa)",
      "滾轉角度 (°)",
      "俯仰角度 (°)",
      "土壤水分 (%)",
      "氮肥 (ppm)",
      "鉀肥 (ppm)"
    ];

    const el = sel => document.querySelector(sel);
    function toast(msg){
      const t = el('#toast'); t.textContent = msg; t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'), 2200);
    }
    function fmtTime(iso){
      try{ return new Date(iso).toLocaleString(); }catch(e){ return "-"; }
    }

    async function fetchFeeds(){
      const url = `https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?api_key=${READ_API_KEY}&results=${RESULTS}&_=${Date.now()}`;
      const r = await fetch(url);
      if(!r.ok) throw new Error('下載資料失敗');
      const json = await r.json();
      return json;
    }

    function createCard(title, canvasId){
      const card = document.createElement('section');
      card.className = 'card';
      card.innerHTML = `<h3>${title}<span class="tag" id="curr-${canvasId}">—</span></h3><div class="body"><canvas id="${canvasId}"></canvas></div>`;
      el('#grid').appendChild(card);
    }

    function buildChart(canvasId, labels, values){
      const ctx = document.getElementById(canvasId);
      if(!ctx) return;

      return new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: '',
            data: values,
            tension: 0.25,
            borderWidth: 2,
            pointRadius: 3, // 小點顯示
            fill: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: false,
          scales: {
            x: { ticks: { autoSkip: true, maxTicksLimit: 4 } },
            y: { beginAtZero: false }
          },
          plugins: {
            legend: { display: false },
            tooltip: { mode: 'index', intersect: false }
          }
        }
      });
    }

    async function sendZero(){
      try{
        el('#zeroBtn').disabled = true;
        const url = `https://api.thingspeak.com/talkbacks/${TALKBACK_ID}/commands.json`;
        const params = new URLSearchParams({ api_key: TALKBACK_API_KEY, command_string: 'ZERO' });
        const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: params });
        if(!r.ok){ throw new Error('TalkBack 送出失敗'); }
        await r.json();
        toast('已送出 ZERO，等待裝置提取執行');
      }catch(err){
        console.error(err);
        toast('送出失敗：' + err.message);
      }finally{
        el('#zeroBtn').disabled = false;
      }
    }

    let charts = [];
    async function load(){
      try{
        const data = await fetchFeeds();
        const feeds = data.feeds || [];
        if(feeds.length===0){ toast('尚無資料'); return; }
        el('#channelName').textContent = data.channel.name || `Channel #${CHANNEL_ID}`;
        el('#lastUpdated').textContent = fmtTime(feeds[feeds.length-1].created_at);

        const xLabels = feeds.map((f, idx) => {
          const t = new Date(f.created_at);
          return isNaN(t) ? `#${idx+1}` : t.toLocaleTimeString();
        });

        const fieldNames = desiredLabels.slice();
        for(let i=1;i<=8;i++){
          const k = `field${i}`;
          if(data.channel && data.channel[k]) fieldNames[i-1] = data.channel[k];
        }

        const grid = el('#grid'); grid.innerHTML = '';
        charts = [];
        for(let i=1;i<=8;i++){
          const fid = `field${i}`;
          const title = fieldNames[i-1] || `Field ${i}`;
          const canvasId = `c${i}`;
          createCard(title, canvasId);

          const arr = feeds.map(f => {
            const v = Number(f[fid]);
            return Number.isFinite(v) ? v : 0;
          });

          const latestRaw = feeds[feeds.length-1][fid];
          el(`#curr-${canvasId}`).textContent = (latestRaw!==null && latestRaw!==undefined && latestRaw!=='') ? latestRaw : '—';

          const chart = buildChart(canvasId, xLabels, arr);
          charts.push(chart);
        }
      }catch(err){
        console.error(err);
        toast(err.message || '載入失敗');
      }
    }

    let timer = null;
    function startAuto(){
      if(timer) clearInterval(timer);
      timer = setInterval(()=>load(), 30000);
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      el('#zeroBtn').addEventListener('click', sendZero);
      load();
      startAuto();
    });
  </script>